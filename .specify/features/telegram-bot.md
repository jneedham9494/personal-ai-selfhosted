# Feature: Telegram Bot Interface

## Status
Retroactive specification for existing feature

## Current Behavior
Telegram bot service that provides chat interface for interacting with the AI assistant. Users can chat with Claude AI, manage projects/goals, search notes, and receive responses - all through Telegram messages.

## Implementation
- **Location:** [telegram.js](src/bots/telegram.js)
- **Class:** `TelegramBotService`
- **Lines:** 559

## Dependencies
- `node-telegram-bot-api` for Telegram API
- `ObsidianService` for vault operations
- `ClaudeService` for AI responses
- `NudgingService` for proactive notifications

## Dependents
- `NudgingService` uses `sendNotification()` method
- `index.js` orchestrates lifecycle

---

## Acceptance Criteria (Current State)

### User Authorization

- GIVEN a new user
  WHEN they send `/start` command
  THEN they are added to authorized users and receive welcome message

- GIVEN an unauthorized user
  WHEN they send any command
  THEN they receive "Unauthorized access" error

### Core Commands

- GIVEN authorized user
  WHEN they send `/help`
  THEN they receive formatted list of all available commands

- GIVEN authorized user
  WHEN they send `/status`
  THEN they receive system status with Claude API, Obsidian, and nudging stats

- GIVEN authorized user with active conversation
  WHEN they send `/clear`
  THEN conversation context is deleted and confirmation sent

### Chat Functionality

- GIVEN authorized user
  WHEN they send a text message (not command)
  THEN message is added to conversation context, Claude generates response, response is sent back

- GIVEN Claude API is not configured
  WHEN user sends a message
  THEN message is acknowledged and saved to Obsidian without AI response

- GIVEN Claude API error (429 rate limit)
  WHEN user sends a message
  THEN friendly error message sent, conversation still saved

- GIVEN conversation with 4+ messages OR 5+ minutes elapsed
  WHEN user sends a message
  THEN conversation is auto-saved to Obsidian

### Project/Goal Context

- GIVEN authorized user
  WHEN they send `/project <name>`
  THEN current conversation saved, project file created in Obsidian, context switched to project

- GIVEN authorized user
  WHEN they send `/goal <name>`
  THEN current conversation saved, goal file created in Obsidian, context switched to goal

- GIVEN user with project/goal context
  WHEN they send `/progress 50 Some note`
  THEN progress updated in Obsidian file with note and percentage

- GIVEN authorized user
  WHEN they send `/context`
  THEN they receive current context info (type, name, message count, duration)

- GIVEN authorized user
  WHEN they send `/new`
  THEN current conversation saved, fresh context created

### Search & Notes

- GIVEN authorized user
  WHEN they send `/search <query>`
  THEN Obsidian vault is searched and up to 5 results returned with excerpts

- GIVEN authorized user
  WHEN they send `/today`
  THEN today's daily note content is returned (or created if missing)

---

## Known Issues / Tech Debt

- [ ] **Memory-based authorization** - Users lose authorization on restart
- [ ] **Polling-based** - Webhook would be more efficient
- [ ] **No input validation** - Project/goal names not sanitized properly
- [ ] **No rate limiting per user** - Could be abused
- [ ] **Topic extraction is basic** - First 5 words only
- [ ] **No voice message support** - Shows placeholder text
- [ ] **Large file (559 lines)** - Should be split into modules
- [ ] **Markdown parsing fragile** - Some responses break formatting

## Future Improvements

- [ ] Persistent user authorization database
- [ ] Webhook-based bot for efficiency
- [ ] Voice message transcription
- [ ] Inline keyboards for interactive UX
- [ ] Command aliases
- [ ] Conversation export command
- [ ] Multi-language support

---

*Generated by SpecKit Retrofit - 2025-11-18*
