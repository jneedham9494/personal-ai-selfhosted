# Feature: 1Password Credential Management

## Status
Retroactive specification for existing feature

## Current Behavior
Service that integrates with 1Password CLI to securely manage API keys and credentials, with fallback to .env file.

## Implementation
- **Location:** [onepassword.js](src/services/onepassword.js)
- **Class:** `OnePasswordService`
- **Lines:** 230

## Dependencies
- 1Password CLI (`op`)
- `child_process.exec` for CLI commands

## Dependents
- `index.js` for configuration loading

---

## Acceptance Criteria (Current State)

### Initialization

- GIVEN 1Password CLI installed
  WHEN service initializes
  THEN version checked, sign-in status verified

- GIVEN 1Password CLI not installed
  WHEN service initializes
  THEN error thrown with message

- GIVEN CLI not signed in
  WHEN service initializes
  THEN helpful instructions logged, error thrown

### Sign-in Status

- GIVEN `op account list` succeeds
  WHEN checking sign-in
  THEN `isSignedIn` set to true

- GIVEN `op account list` fails
  WHEN checking sign-in
  THEN `isSignedIn` set to false, setup instructions logged

### Vault Setup

- GIVEN vault name "Personal AI Assistant"
  WHEN `setupAIAssistantVault()` called
  THEN vault created if not exists

- GIVEN vault exists
  WHEN setup runs
  THEN uses existing vault

- GIVEN vault setup
  WHEN `createItem()` called
  THEN "AI Assistant Credentials" secure note created with template fields

### Configuration Loading

- GIVEN credentials in vault
  WHEN `loadConfiguration()` called
  THEN reads: ANTHROPIC_API_KEY, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, OBSIDIAN_VAULT_PATH

- GIVEN secret reference
  WHEN `getSecret()` called
  THEN `op read` executes and returns trimmed value

- GIVEN placeholder values (e.g., "your_claude_api_key_here")
  WHEN loading
  THEN value skipped with warning

- GIVEN missing secret
  WHEN loading fails
  THEN warning logged, continues with other secrets

- GIVEN all secrets loaded
  WHEN returning config
  THEN default values added for PORT, NODE_ENV, etc.

### Item Management

- GIVEN field and new value
  WHEN `updateCredential()` called
  THEN `op item edit` updates the credential

### Fallback Behavior

- GIVEN 1Password unavailable
  WHEN `index.js` loads config
  THEN falls back to `process.env` from .env file

---

## Known Issues / Tech Debt

- [ ] **Shell injection risk** - Should escape values in exec calls
- [ ] **Blocking exec** - Should use non-blocking approach
- [ ] **No caching** - Reads from 1Password on every load
- [ ] **Hardcoded vault/item names** - Should be configurable
- [ ] **No credential rotation** - Can't auto-update expired keys
- [ ] **Error messages expose paths** - Security concern

## Future Improvements

- [ ] Sanitize inputs for exec commands
- [ ] Cache credentials with TTL
- [ ] Configurable vault/item names
- [ ] Credential rotation support
- [ ] Secure error messages
- [ ] Service account support
- [ ] Connect SDK instead of CLI

---

*Generated by SpecKit Retrofit - 2025-11-18*
