# Feature: Proactive Nudging System

## Status
Retroactive specification for existing feature

## Current Behavior
Cron-based proactive messaging system that analyzes conversation patterns and sends contextual reminders, motivational messages, and weekly reviews via Telegram.

## Implementation
- **Location:** [nudging.js](src/services/nudging.js)
- **Class:** `NudgingService`
- **Lines:** 544

## Dependencies
- `cron` for scheduled jobs
- `ObsidianService` for conversation and project data
- `TelegramBotService` for sending notifications
- `ClaudeService` for pattern analysis (optional)

## Dependents
- `index.js` for lifecycle management
- `TelegramBotService` status command

---

## Acceptance Criteria (Current State)

### Initialization

- GIVEN enabled config and chat ID
  WHEN service starts
  THEN analysis job scheduled, regular nudges scheduled

- GIVEN disabled config or no chat ID
  WHEN service starts
  THEN service logs warning and remains inactive

### Scheduled Nudges

- GIVEN 9:00 AM
  WHEN morning cron fires
  THEN random motivational message sent (if passes shouldSendNudge check)

- GIVEN 2:00 PM
  WHEN afternoon cron fires
  THEN check-in message sent, references todo items if present in daily note

- GIVEN 7:00 PM
  WHEN evening cron fires
  THEN reflection prompt sent

- GIVEN Sunday 6:00 PM
  WHEN weekly review cron fires
  THEN review message with project progress bars sent

- GIVEN Wednesday 10:00 AM
  WHEN mid-week check cron fires
  THEN projects needing attention highlighted

### Conversation Analysis

- GIVEN analysis interval (default 60 min)
  WHEN cron fires during active hours
  THEN recent conversations analyzed for patterns

- GIVEN recent conversations
  WHEN `analyzeConversationPatterns()` called
  THEN mood, topics, goals, and challenges extracted

- GIVEN keyword patterns
  WHEN analyzing
  THEN stress/energy detected from keyword lists, goals from "want to"/"need to" patterns

### Contextual Nudges

- GIVEN mood='stressed'
  WHEN nudges generated
  THEN wellness nudge with break suggestion included

- GIVEN fitness topic detected and hour > 16
  WHEN nudges generated
  THEN activity reminder included

- GIVEN goals detected and 10 < hour < 15
  WHEN nudges generated
  THEN goal reminder with progress question included

- GIVEN no messages today and hour > 12
  WHEN nudges generated
  THEN general check-in included

### Nudge Rate Limiting

- GIVEN daily limit (default 5)
  WHEN limit reached
  THEN no more nudges sent that day

- GIVEN nudge type
  WHEN same type sent within 2 hours
  THEN nudge skipped

- GIVEN nudge priority
  WHEN checking shouldSend
  THEN probabilistic: high=80%, medium=50%, low=30%

### Active Hours

- GIVEN hour < startHour (default 8) OR hour > endHour (default 22)
  WHEN any nudge checks
  THEN nudge not sent

### Project/Goal Tracking

- GIVEN projects in vault
  WHEN weekly review runs
  THEN projects sorted by priority/progress, progress bars generated

- GIVEN projects not updated in 7+ days
  WHEN mid-week check runs
  THEN projects flagged as needing attention

---

## Known Issues / Tech Debt

- [ ] **Large file (544 lines)** - Should be split into modules
- [ ] **Simple keyword analysis** - Not using Claude effectively
- [ ] **In-memory history** - Lost on restart
- [ ] **Hardcoded cron times** - Not configurable
- [ ] **No timezone handling** - Assumes local time
- [ ] **No user preferences** - Same nudges for everyone
- [ ] **No nudge feedback** - Can't learn preferences
- [ ] **Probabilistic sending** - Could be smarter

## Future Improvements

- [ ] Configurable nudge schedule
- [ ] Timezone-aware scheduling
- [ ] User preference learning
- [ ] Nudge feedback mechanism
- [ ] Claude-powered analysis
- [ ] Adaptive nudge frequency
- [ ] Snooze functionality
- [ ] Do Not Disturb mode
- [ ] Calendar integration

---

*Generated by SpecKit Retrofit - 2025-11-18*
