# Feature: Claude AI Service

## Status
Retroactive specification for existing feature

## Current Behavior
Service that wraps the Anthropic Claude API with rate limiting, error handling, and specialized analysis methods for the nudging system.

## Implementation
- **Location:** [claude.js](src/services/claude.js)
- **Class:** `ClaudeService`
- **Lines:** 151

## Dependencies
- `@anthropic-ai/sdk` for Claude API

## Dependents
- `TelegramBotService` for conversation responses
- `ObsidianService` for summaries and insights
- `NudgingService` for pattern analysis

---

## Acceptance Criteria (Current State)

### Initialization

- GIVEN valid API key
  WHEN service initialized
  THEN Anthropic client created and rate limiter configured

- GIVEN missing or placeholder API key
  WHEN service initialized
  THEN client set to null, warning logged, service continues in degraded mode

### Response Generation

- GIVEN messages array and client configured
  WHEN `generateResponse()` called
  THEN Claude API called with formatted messages and system prompt

- GIVEN default options
  WHEN generating response
  THEN uses: model=claude-3-haiku-20240307, max_tokens=1000, temperature=0.7

- GIVEN custom options
  WHEN generating response
  THEN options override defaults (model, maxTokens, temperature, systemPrompt)

- GIVEN successful response
  WHEN returned
  THEN request tracked for rate limiting, character count logged

### Rate Limiting

- GIVEN rate limit not exceeded (< 50 requests/minute)
  WHEN `checkRateLimit()` called
  THEN returns true

- GIVEN rate limit exceeded (>= 50 requests/minute)
  WHEN `checkRateLimit()` called
  THEN returns false

- GIVEN rate limit exceeded
  WHEN `generateResponse()` called
  THEN throws "Rate limit exceeded" error

- GIVEN requests older than 1 minute
  WHEN rate limit checked
  THEN old requests removed from tracking array

### Error Handling

- GIVEN 429 status from API
  WHEN error caught
  THEN friendly "Rate limit exceeded" message thrown

- GIVEN 401 status from API
  WHEN error caught
  THEN "Invalid API key" message thrown

- GIVEN other API errors
  WHEN error caught
  THEN "Claude API temporarily unavailable" message thrown

### Pattern Analysis (for Nudging)

- GIVEN conversation history and analysis type
  WHEN `analyzeConversationPatterns()` called
  THEN Claude analyzes with specific prompt for mood/goals/patterns

- GIVEN mood analysis type
  WHEN analyzing
  THEN returns assessment of stress, energy, focus levels

- GIVEN goals analysis type
  WHEN analyzing
  THEN returns list of commitments and action items

- GIVEN patterns analysis type
  WHEN analyzing
  THEN identifies recurring themes and time patterns

### System Prompt

- GIVEN default system prompt
  WHEN used
  THEN configures Claude as personal assistant aware of Obsidian integration

### Usage Statistics

- GIVEN service instance
  WHEN `getUsageStats()` called
  THEN returns: configured status, recent requests count, remaining rate limit

---

## Known Issues / Tech Debt

- [ ] **Hardcoded model** - Should be configurable
- [ ] **In-memory rate limiting** - Lost on restart
- [ ] **No retry logic** - Single failure = error
- [ ] **No request timeout** - Could hang indefinitely
- [ ] **No response caching** - Redundant API calls
- [ ] **No token counting** - Can't optimize costs
- [ ] **No streaming support** - Waits for full response

## Future Improvements

- [ ] Configurable model selection
- [ ] Persistent rate limiting
- [ ] Retry with exponential backoff
- [ ] Request timeout configuration
- [ ] Response caching
- [ ] Token usage tracking
- [ ] Streaming response support
- [ ] Multiple API key rotation
- [ ] Cost optimization features

---

*Generated by SpecKit Retrofit - 2025-11-18*
